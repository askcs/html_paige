<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=no; minimum-scale=1.0;">
		<link rel="stylesheet" type="text/css" href="style/main.css" />
		<!--     <link href='http://fonts.googleapis.com/css?family=Squada+One' rel='stylesheet' type='text/css'> -->
		
		<!-- <script src="js/jquery-1.7.2.min.js"></script>
		<script src="js/jquery.ui.core-1.8.17.min.js"></script>
		<script src="js/jquery.ui.widget-1.8.17.min.js"></script> -->
		
		<script src="js/libs.min.js" type="text/javascript"></script>
		<script src="js/core.min.js" type="text/javascript"></script>
		<script type="text/javascript">
			paigeUser.init();			
		</script>
		<script src="js/phone.min.js" type="text/javascript"></script>

		<script type="text/javascript">
			$(document).ready(function() {
				buildHeader();

				$("#toggleMenu").click(function() {
					$(this).toggleClass("notActive, active");
					$("#headerMenu").toggleClass("displayNone");
				});

				buildFooter('Home');

				$("#callButton").click(function() {
					$(window).scrollTop('0');
					$("#callPopUp").removeClass("displayNone");
					$('#callPopUp').load('contents/callpopup.html');
				});
				
				var buttonObj = {
					timeoutStop : function(){
						$("#timeoutButton").removeClass("pushed");
						$("#timeoutButton").addClass("notPushed");
						$("#timerTitle").show();
						$("#timer").hide();
						$("#timeoutStarted").slideUp();
						
						$("#timeoutButton").data("active",false);
						$("#timeoutButton").data("continued",false);
						javascript_countdown.stop();
					},
					renderNotes : function(res){
						var notes = JSON.parse(res);
						
						notes.sort(function(a,b){
							var a_time = new Date(a.creationTime);
							var b_time = new Date(b.creationTime);
							return (b_time.getTime() - a_time.getTime());
						})
						
						$('#notesBlock #notesWeekOverview').empty();
						notes.map(function(note){
							var createTime = new Date(note.creationTime);
 							$('#notesBlock #notesWeekOverview').append("<div class=\"note\"><div class=\"date\">"+createTime.toDateString()+"<span class=\"time\">"+createTime.toLocaleTimeString()+"</span></div>"+note.content+"<div class=\"message\"></div></div>");
						});
					}
				}
				
				$("#callButton").data('buttonObj',buttonObj);
				
				var timeoutRenderer = function(json, olddata, cache) {
					console.log(json);
					
					if(json != null ){
						var toOjb = json[0];
						
						if($("#timeoutButton").data("inStarting")){
							return;
						}
						
						if(typeof toOjb != "undefined" && toOjb.status == "active"){
							
							var continued = toOjb.now-toOjb.startTime;
							var itvs = toOjb.interval.split(',');
							var duration = 0;
							for(var i=0 ; i < itvs.length ; i++){
								duration += parseInt(itvs[i]);
							}
							// duration = duration*60;
							 
							var countdownNumber = duration-continued;
							 
							javascript_countdown.enable();
							
							if(typeof $("#timeoutButton").data("continued") == "undefined"
								|| $("#timeoutButton").data("continued") == false){
								console.log("Start counting ... "+ countdownNumber);
								
								javascript_countdown.init(countdownNumber);
								
								$("#timeoutButton").data("continued",true);
							}else{
								javascript_countdown.setTimeLeft(countdownNumber);
							}
							
							$("#timeoutButton").removeClass("notPushed");
							$("#timeoutButton").addClass("pushed");
							$("#timerTitle").hide();
							$("#timer").show();
							$("#timeoutStarted").slideDown();
							
							$.map(toOjb.attendees,function(v,k){
								if(k == session.uuid ){
									$('#timeoutStarted #message p').empty();
									if(countdownNumber < 150){
										$('#timeoutStarted #message p').append("<span class=\"bold\">De time-out is begonnen.</span><br><br>");
									}
									
									$('#timeoutStarted #message p').append((v.msg == null && typeof v.msg == "undefined")? "": v.msg );
								}
							});
							
							$("#timeoutButton").data("active",true);
						}else if(typeof toOjb != "undefined" && toOjb.status == "inactive"){
							console.log("Timeout stoped ! ");
							$("#callButton").data('buttonObj').timeoutStop();
						}
					}
				}
				// check the if the sensor is initialized  
				
				// $(window).scrollTop('0');
				// $("#callPopUp").removeClass("displayNone");
				// $('#callPopUp').load('contents/sensorChecking.html');
				
				
				var checkSensorCount = 0;
				var initSensorLimit = 0;
				if (window.plugins.sense && phoneGapAvailable) {
					window.plugins.sense.flushBuffer(function() {
					}, function() {});
				}
				
				var checkSensor = function(){
					
					if($("#callButton").data("initSensor") != true){
						if(initSensorLimit > 20){
							alert("Something wrong in your sensor ! Please try to login again ! ");
							session.logoff();
							return;
						}
						
						if(checkSensorCount > 5){
							if (window.plugins.sense && phoneGapAvailable) {
								window.plugins.sense.flushBuffer(function() {
								}, function() {});
							}else{
								$("#callButton").data("initSensor",true); 
							}
							checkSensorCount = 0;
						}
						
						console.log("checking the sensor ..."+checkSensorCount);
						dataCon.get("timeout/checkSensor",null,function(res){
							console.log(res);
							if(res == "ok"){
								$("#callButton").data("initSensor",true);
								$("#callPopUp").addClass('displayNone');
							}else{
								setTimeout(function(){
									checkSensor();
								},3000);
							}
						});
						checkSensorCount++;
						initSensorLimit++;
					}
				}
				
				// checkSensor();
				
				//start to check timeout status every 30 seconds 
				var cache = new ASKCache("getTimeout", "timeout", null, "uuid", session);
				cache.addRenderer('/home.html', timeoutRenderer,true);
				
				setTimeout(function(){
					caches.showList("getTimeout");
				},3000);
				
				
				$('#timeoutButton').live('click',function(){
					// start timeout !! 
					console.log("active: "+$("#timeoutButton").data("active"));
					if($("#timeoutButton").data("active") == false){
						$("#timeoutButton").data("active",true);
						$("#timeoutButton").data("inStarting",true);
						
						$(this).removeClass("notPushed");
						$(this).addClass("pushed");
						$("#timerTitle").hide();
						$("#timer").show();
						$("#timeoutStarted").slideDown();
						$("#javascript_countdown_time").text("Starting...");
					
						dataCon.get("timeout/start",null,function(res){
							console.log(res);
							$("#timeoutButton").data("inStarting",false);
							$("#timeoutButton").data("continued",false);
							setTimeout(function(){
								caches.showList("getTimeout");
							},3000);
						});
					}
				})
				
				console.log("c2dmKey:"+localStorage['C2DMKey']);
				if(localStorage['C2DMKey'] != null && typeof localStorage['C2DMKey'] != "undefined"){
					dataCon.post("timeout/setC2DM",{"key":localStorage['C2DMKey']},function(){
						var t_cache = caches.getList("getTimeout")[0];
						t_cache.setInterval(900000); // Since we have C2DM set dialog to low
					});						// interval (15 min)
				}else{
					console.log("C2DM Key init wrong! ");
				}
				
				// notification page
				$('#notesBlock #addNoteIcon').live("click",function(){
					changeDivPage("addNotesBlock",null,null);
				});
				 
				$('#addNotesBlock #sendNote').live('click',function(){
					var note = $.trim($('#addNotesBlock #timeout_note').val());
					if(note == ""){
						alert("Note can't be empty");
						return;
					}
					var para = {'content' : note};
					$('#addNotesBlock #sendingNote').show();
					$('#addNotesBlock #sendNote').hide();
					dataCon.post("timeout/notes",para,function(res){
						setTimeout(function(){
							changeDivPage("notesBlock",null,null);
							$('#addNotesBlock #sendingNote').hide();
							$('#addNotesBlock #sendNote').show();
							$('#addNotesBlock #timeout_note').val("");
						},3000);
					})
				})
				
				$('#addNotesBlock #sendingNote').hide();
				
				console.log($('#indexMainContent').data("currentPage"));
				if(typeof $('#indexMainContent').data("currentPage") == "undefined"){
					changeDivPage("timeoutBlock",null,null);
				}
			});
			function blockMove() {
				event.preventDefault();
			}

			function checkLogin() {
				session.authenticator();
			}
			
			// display the page
			var changeDivPage = function(pageId, callback,from){
				if(typeof $('#indexMainContent').data("privPage") == "undefined"){
					$('#indexMainContent').data("privPage","timeoutBlock");
				}
				
				$($('#'+$('#indexMainContent').data("currentPage"))[0]).css('display','none');
				
				$('#indexMainContent').data("privPage",$('#indexMainContent').data("currentPage"));
				$($('#'+pageId)[0]).css('display','block');
				$('#indexMainContent').data("currentPage",pageId);
				
				if(typeof callback != "undefined" && callback != null){
					callback();
				}
				
				if(from != null){
					$('.footerMenuArrow').remove();
					$(from).prepend('<div class="footerMenuArrow"></div>');
				}
				
				
				if(pageId == "notesBlock"){
					if($('#notesBlock #notesOverview .loadingNote').length == 0){
						$('#notesBlock #notesWeekOverview').append("<div id=\"noteHeader\"><div class=\"title loadingNote\" >loadinghet laden van notities ...</div></div>");
						dataCon.get("timeout/notes",null,function(res){
							$("#callButton").data('buttonObj').renderNotes(res);
						});
					}
				}
			}
		</script>
		
		<script type="text/javascript">
			var javascript_countdown = function() {
				var time_left = 10;
				//number of seconds for countdown
				var keep_counting = 1;
				var no_time_left_message = '00:00';
				var finished_message = '<p><span class="bold">De time-out is over.</span></br></br>Jullie zijn beiden gekalmeerd, jullie kunnen bij elkaar komen om het verder uit te praten.</p>';
				var duration = 0;
				var startpoint = 0;
				function countdown() {
					if(time_left < 2) {
						keep_counting = 0;
					}
					//time_left = time_left - 1;
					var now = (new Date().getTime() * 0.001)|0;
					time_left = duration - (now - startpoint); 
				}

				function add_leading_zero(n) {
					if(n.toString().length < 2) {
						return '0' + n;
					} else {
						return n;
					}
				}

				function format_output() {
					// var hours, minutes, seconds;
					// seconds = time_left % 60;
					// minutes = Math.floor(time_left / 60) % 60;
					// hours = Math.floor(time_left / 3600);
					// seconds = add_leading_zero(seconds);
					// minutes = add_leading_zero(minutes);
					// hours = add_leading_zero(hours);
					// use device clock
					 
					var hours, minutes, seconds;
					seconds = time_left % 60;
					minutes = Math.floor(time_left / 60) % 60;
					hours = Math.floor(time_left / 3600);
					seconds = add_leading_zero(seconds);
					minutes = add_leading_zero(minutes);
					hours = add_leading_zero(hours);
					return minutes + ':' + seconds;
				}

				function show_time_left() {
					document.getElementById('javascript_countdown_time').innerHTML = format_output();
					//time_left;
				}

				function no_time_left() {
					document.getElementById('javascript_countdown_time').innerHTML = no_time_left_message;
					document.getElementById('message').innerHTML = finished_message;
					$("#callButton").data('buttonObj').timeoutStop();
				}

				return {
					count : function() {
						countdown();
						show_time_left();
					},
					timer : function() {
						javascript_countdown.count();
						// console.log("in timer "+ time_left);
						if(keep_counting) {
							setTimeout("javascript_countdown.timer();", 1000);
						} else {
							no_time_left();
						}
					},
					init : function(n) {
						time_left = n;
						// other solution using device time 
						duration = n;
						startpoint = (new Date().getTime() * 0.001)|0;
						console.log(startpoint);
						javascript_countdown.timer();
					},
					stop : function(){
						keep_counting = 0;
					},
					enable : function(){
						keep_counting = 1;
					},
					setTimeLeft : function(left){
						time_left = left;
					}
				};
			}();

		</script>
		
		<script type="text/javascript">
			// for init emotion page
			$('#emotionBlock #button').ready(function(){
				$('#emotionBlock #button').affectbutton();
			})
	  		
	  		$('#emotionBlock #saveEmotion').live("click",function(){
	  			if($('#emotionBlock #saveEmotion').data("submited") == true){
	  				$('#emotionMainContent #button').text("Sending the emotion ... ");
	  				setTimeout(function(){
	  					$('#emotionMainContent #button').text("Opslaan ... ");
	  				},3000);
	  				return;
	  			}
	  			
	  			var val = $('#emotionMainContent #button').affectbutton('affect');
	  			$('#emotionBlock #saveEmotion').data("submited",true);
	  			$('#emotionMainContent #button').text("Submitting ... ");
	  			
				if (window.plugins.sense && phoneGapAvailable) {
					window.plugins.sense.addDataPoint('emotion', 'Emotie', 'Timeout'
					, 'json', JSON.stringify(val) , (new Date()).getTime()
					, function() {
						// success!
						window.plugins.sense.flushBuffer(function() {
							$('#emotionBlock #saveEmotion').data("submited",false);
							$('#emotionMainContent #button').text("Opslaan");
							
							changeDivPage("timeoutBlock",function(){
								// caches.showList("getTimeout");
							});
							
							// put a message after user input their emotion
							$('#timeoutStarted #message p').empty();
							// this is for 0 - 5 min
							$('#timeoutStarted #message p').append("Bedankt voor het invullen van je emotie. Als jullie je allebei weer rustig voelen zijn en de minimale time-outtijd verstreken wordt de time-out gestopt.");
							
							// this is for 5 - 10 min
							// $('#timeoutStarted #message p').append("Bedankt voor het invullen van je emotie. Fijn dat het weer beter met je gaat. De time-out loopt nog steeds. Zodra jullie beiden weer helemaal rustig zijn stopt de time-out.");
						}, function() {});
						
					}, function() {
						console.log('Failed to write data to Sense!');
					});
				}else{
					
					// no phonegap and sense  , start to simulate the call for changing the emotion
					$('#timeoutStarted #message p').empty();
					$('#timeoutStarted #message p').append("<span class=\"bold\">De time-out is begonnen.</span><br><br>");
					$('#timeoutStarted #message p').append("Bedankt voor het invullen van je emotie.");
					
					$('#emotionBlock #saveEmotion').data("submited",false);
					
					changeDivPage("timeoutBlock",function(){
						// caches.showList("getTimeout");
					});
				}
	  		});
		</script>
		<title>Time out!</title>
	</head>
	<body onload="checkLogin()">
		<div id="callPopUp" class="popUp displayNone" ontouchmove="blockMove()"></div>
		<div id="contentContainer" class="indexPage">
			<div id="header"></div>
			<div style="width:100%; height:1px;"></div>
			<div id="indexMainContent" class="mainContent">
				<div id="timeoutBlock" style="display: none;">
					<div id="timeoutButton" class="notPushed"  ></div>
					<div id="timeoutContainer" class="bgWhite">
						<div id="blueField" class="bgBlue">
							<p id="timerTitle">
								Time out!
							</p>
							<div id="timer" class=" displayNone">
								<div style="margin:0px 10px 0 144px;">
									<div id="countdownBackground" class="bgWhite">
										<div id="javascript_countdown_time" class="countDown">
											Starting...
										</div>
									</div>
								</div>
								<p>
									
								</p>
							</div>
						</div>
						<div id="timeoutStarted" class="displayNone">
							<div id="message">
								<p>
									<span class="bold">De time-out is begonnen.</span>
									<br/>
									<br/>
									Ik merk dat je even afleiding nodig hebt, ga lekker iets doen waarvan jij weer kalmeert.
								</p>
							</div>
						</div>
					</div>
				</div>
				<div id="emotionBlock" style="display: none;">
					<div id="emotionMainContent" class="mainContent">
			    		<div id="moodieContainer">
			    			<div id="moodieText"><p>Geef je emotie aan.</p></div>
				    		<canvas id="button" width="262px" height="262px" >
								(Canvas not supported!)
							</canvas>
							<div id="saveEmotion"  class="button">Opslaan</div>
						</div>
			    	</div>
				</div>			
				<div id="notesBlock" style="display: none;">
						<div id="notesOverview">   	
					    	<div id="noteHeader">
					    		<div class="title">Notitie-overzicht</div>
					    		<div id="notesMenu">
					    			<div id="addNoteIcon" class="menuIconLink"><a></a></div>
					    		</div>
					    	</div>
				    		<div id="notesWeekOverview">
				    		</div>
				    	</div>
				</div>
				<div id="addNotesBlock" style="display: none;" >
					<div id="editNoteMainContent" class="mainContent">
			    	<div id="notesOverview">
			    		<div id="noteHeader">
			    		<div id="backIcon" class="menuIconBackLink"><a href="javascript:changeDivPage('notesBlock',null,null);"></a></div>
				    		<div class="title">Notitie</div>
				    	</div>
			    		<div id="notesWeekOverview">
			    			<div class="note">
			    				<textarea class="message" id="timeout_note"></textarea>
								<input type="button" id="sendNote" value="Opslaan">
								<input type="button" id="sendingNote" value="Sending">
								<div class="clear"></div>
			    			</div>
			    		</div>
			    	</div>
				</div>
			</div>
			<div id="spaceFooter"></div>
		</div>
		</div>
	</body>
</html>
