<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=no; minimum-scale=1.0;">
		<link rel="stylesheet" type="text/css" href="style/main.css" />
		<!--     <link href='http://fonts.googleapis.com/css?family=Squada+One' rel='stylesheet' type='text/css'> -->
		<script src="js/jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="js/prefixfree.min.js" type="text/javascript"></script>
		<script src="js/timeout.js" type="text/javascript"></script>
		<script src="js/app.js" type="text/javascript"></script>

		
		<!-- <script src="js/askRest_cache.js" type="text/javascript"></script> -->
		<script type="text/javascript">
			$(document).ready(function() {

				buildHeader();

				$("#toggleMenu").click(function() {
					$(this).toggleClass("notActive, active");
					$("#headerMenu").toggleClass("displayNone");
				});

				$("#timeoutButton").click(function() {
					$(this).removeClass("notPushed");
					$(this).addClass("pushed");
					$("#timerTitle").hide();
					$("#timer").show();
					$("#timeoutStarted").slideDown();
				});
				buildFooter('Home');

				$("#callButton").click(function() {
					$(window).scrollTop('0');
					$("#callPopUp").removeClass("displayNone");
					$('#callPopUp').load('contents/callpopup.html');
				});
				
				$('#timeoutBlock').data("remoteDataChange",false);
				
				var timeoutRenderer = function(json, olddata, cache) {
					console.log(json);
					
					if(json != null ){
						var toOjb = json[0];
						console.log("remote change : ",$('#timeoutBlock').data("remoteDataChange")); 
						if($('#timeoutBlock').data("remoteDataChange") == true){
							
							if(toOjb.remoteDataChange == "true"){
								console.log("remote change : ",$('#timeoutBlock').data("remoteDataChange"));
								$('#timeoutBlock').data("remoteDataChange",false);
								dataCon.post("timeout/remoteChange",null,function(res){
									console.log(res);
								});
							}else{
								return;
							}
						}
						
						if(toOjb.status == "active"){
							var now = Math.round((new Date()).getTime() / 1000);
							var continued = now-toOjb.startTime;
							var itvs = toOjb.interval.split(',');
							var duration = 0;
							for(var i=0 ; i < itvs.length ; i++){
								duration += parseInt(itvs[i]);
							}
							duration = duration*60;
							 
							var countdownNumber = duration-continued; 
							
							if(typeof $("#timeoutButton").data("continued") == "undefined"
								|| $("#timeoutButton").data("continued") == false){
								console.log("Start counting ... ", countdownNumber);
								javascript_countdown.init(countdownNumber);
								$("#timeoutButton").data("continued",true);
							}
							
							$("#timeoutButton").removeClass("notPushed");
							$("#timeoutButton").addClass("pushed");
							$("#timerTitle").hide();
							$("#timer").show();
							$("#timeoutStarted").slideDown();
							
							$.map(toOjb.attendees,function(v,k){
								if(k == session.uuid ){
									$('#timeoutStarted #message p').empty();
									$('#timeoutStarted #message p').append("<span class=\"bold\">De time-out is begonnen.</span><br><br>");
									$('#timeoutStarted #message p').append((v.msg == null && typeof v.msg == "undefined")? "": v.msg );
								}
							});
							
							$("#timeoutButton").data("active",true);
						}else if(toOjb.status == "inactive"){
							
							$("#timeoutButton").removeClass("pushed");
							$("#timeoutButton").addClass("notPushed");
							$("#timerTitle").show();
							$("#timer").hide();
							$("#timeoutStarted").slideUp();
							
							$("#timeoutButton").data("active",false);
							$("#timeoutButton").data("continued",false);
						}
					}
				}
				
				// start to check timeout status every 30 seconds 
				var cache = new ASKCache("getTimeout", "timeout", null, "uuid", session);
				cache.addRenderer('/home.html', timeoutRenderer,true);
				
				setTimeout(function(){
					caches.showList("getTimeout");
				},3000);
				
				$('#timeoutButton').live('click',function(){
					if($("#timeoutButton").data("active") == false){
						$("#timeoutButton").data("active",true);
						$('#timeoutBlock').data("remoteDataChange",true);
						dataCon.get("timeout/start",null,function(res){
							console.log(res);
							setTimeout(function(){
								caches.showList("getTimeout");
							},3000);
						});
					}
				})
				
				
				// notification page
				
				 
				
				
				if(typeof $('#indexMainContent').data("currentPage") == "undefined"){
					changeDivPage("timeoutBlock");
				}
			});
			function blockMove() {
				event.preventDefault();
			}

			function checkLogin() {
				session.authenticator();
			}
			
			// display the page
			var changeDivPage = function(pageId, callback){
				if(typeof $('#indexMainContent').data("privPage") == "undefined"){
					$('#indexMainContent').data("privPage","timeoutBlock");
				}
				
				$($('#'+$('#indexMainContent').data("currentPage"))[0]).css('display','none');
				
				$('#indexMainContent').data("privPage",$('#indexMainContent').data("currentPage"));
				$($('#'+pageId)[0]).css('display','block');
				$('#indexMainContent').data("currentPage",pageId);
				
				if(typeof callback != "undefined"){
					callback();
				}
									
			}
		</script>
		
		<script type="text/javascript">
			var javascript_countdown = function() {
				var time_left = 10;
				//number of seconds for countdown
				var keep_counting = 1;
				var no_time_left_message = '00:00';
				var finished_message = '<p><span class="bold">De time-out is finished.</span></br></br>Jullie zijn beiden gekalmeerd, jullie kunnen bij elkaar komen om het verder uit te praten.</p>';
				function countdown() {
					if(time_left < 2) {
						keep_counting = 0;
					}
					time_left = time_left - 1;
				}

				function add_leading_zero(n) {
					if(n.toString().length < 2) {
						return '0' + n;
					} else {
						return n;
					}
				}

				function format_output() {
					var hours, minutes, seconds;
					seconds = time_left % 60;
					minutes = Math.floor(time_left / 60) % 60;
					hours = Math.floor(time_left / 3600);
					seconds = add_leading_zero(seconds);
					minutes = add_leading_zero(minutes);
					hours = add_leading_zero(hours);
					return minutes + ':' + seconds;
				}

				function show_time_left() {
					document.getElementById('javascript_countdown_time').innerHTML = format_output();
					//time_left;
				}

				function no_time_left() {
					document.getElementById('javascript_countdown_time').innerHTML = no_time_left_message;
					document.getElementById('message').innerHTML = finished_message;
					caches.showList("getTimeout");
				}

				return {
					count : function() {
						countdown();
						show_time_left();
					},
					timer : function() {
						javascript_countdown.count();
						if(keep_counting) {
							setTimeout("javascript_countdown.timer();", 1000);
						} else {
							no_time_left();
						}
					},
					init : function(n) {
						time_left = n;
						javascript_countdown.timer();
					}
				};
			}();

		</script>
		
		<script type="text/javascript">
			// for init emotion page
			$('#emotionBlock #button').ready(function(){
				$('#emotionBlock #button').affectbutton();
			})
	  		
	  		$('#emotionBlock #saveEmotion').live("click",function(){
	  			if($('#emotionBlock #saveEmotion').data("submited") == true){
	  				$('#emotionMainContent #button').text("Sending the emotion ... ");
	  				setTimeout(function(){
	  					$('#emotionMainContent #button').text("Opslaan ... ");
	  				},3000);
	  				return;
	  			}
	  			
	  			var val = $('#emotionMainContent #button').affectbutton('affect');
	  			$('#emotionBlock #saveEmotion').data("submited",true);
	  			$('#emotionMainContent #button').text("Submitting ... ");
	  			
	  			$('#timeoutBlock').data("remoteDataChange",true);
	  			
				if (window.plugins.sense && phoneGapAvailable) {
					window.plugins.sense.addDataPoint('emotion', 'Emotie', 'Timeout'
					, 'json', JSON.stringify(val) , (new Date()).getTime()
					, function() {
						// success!
						window.plugins.sense.flushBuffer(function() {
							$('#emotionBlock #saveEmotion').data("submited",false);
							$('#emotionMainContent #button').text("Opslaan");
							
							changeDivPage("timeoutBlock",function(){
								caches.showList("getTimeout");
							});
							
							// put a message after user input their emotion
							$('#timeoutStarted #message p').empty();
							$('#timeoutStarted #message p').append("<span class=\"bold\">De time-out is begonnen.</span><br><br>");
							// this is for 0 - 5 min
							$('#timeoutStarted #message p').append("Bedankt voor het invullen van je emotie. Als jullie je allebei weer rustig voelen zijn en de minimale time-outtijd verstreken wordt de time-out gestopt.");
							
							// this is for 5 - 10 min
							// $('#timeoutStarted #message p').append("Bedankt voor het invullen van je emotie. Fijn dat het weer beter met je gaat. De time-out loopt nog steeds. Zodra jullie beiden weer helemaal rustig zijn stopt de time-out.");
						}, function() {});
						
					}, function() {
						console.log('Failed to write data to Sense!');
					});
				}else{
					
					// no phonegap and sense  , start to simulate the call for changing the emotion
					$('#timeoutStarted #message p').empty();
					$('#timeoutStarted #message p').append("<span class=\"bold\">De time-out is begonnen.</span><br><br>");
					$('#timeoutStarted #message p').append("Thanks for filling your emotion");
					
					$('#emotionBlock #saveEmotion').data("submited",false);
					
					changeDivPage("timeoutBlock",function(){
						// caches.showList("getTimeout");
					});
				}
	  		});
		</script>
		<title>Time out!</title>
	</head>
	<body onload="checkLogin()">
		<div id="callPopUp" class="popUp displayNone" ontouchmove="blockMove()"></div>
		<div id="contentContainer" class="indexPage">
			<div id="header"></div>
			<div style="width:100%; height:1px;"></div>
			<div id="indexMainContent" class="mainContent">
				<div id="timeoutBlock" style="display: none;">
					<div id="timeoutButton" class="notPushed"  ></div>
					<div id="timeoutContainer" class="bgWhite">
						<div id="blueField" class="bgBlue">
							<p id="timerTitle">
								Time out!
							</p>
							<div id="timer" class=" displayNone">
								<div style="margin:0px 10px 0 144px;">
									<div id="countdownBackground" class="bgWhite">
										<div id="javascript_countdown_time" class="countDown">
											Starting...
										</div>
									</div>
								</div>
								<p>
									
								</p>
							</div>
						</div>
						<div id="timeoutStarted" class="displayNone">
							<div id="message">
								<p>
									<span class="bold">De time-out is begonnen.</span>
									<br/>
									<br/>
									Ik merk dat je even afleiding nodig hebt, ga lekker iets doen waarvan jij weer kalmeert.
								</p>
							</div>
						</div>
					</div>
				</div>
				<div id="emotionBlock" style="display: none;">
					<div id="emotionMainContent" class="mainContent">
			    		<div id="moodieContainer">
			    			<div id="moodieText"><p>Geef je emotie aan.</p></div>
				    		<canvas id="button" width="262px" height="262px" >
								(Canvas not supported!)
							</canvas>
							<div id="saveEmotion"  class="button">Opslaan</div>
						</div>
			    	</div>
				</div>			
				<div id="notesBlock" style="display: none;">
						<div id="notesOverview">   	
					    	<div id="noteHeader">
					    		<div class="title">Notitie-overzicht</div>
					    		<div id="notesMenu">
					    			<div id="addIcon" class="menuIconLink"><a ></a></div>
					    		</div>
					    	</div>
				    		<div id="notesWeekOverview">
				    			<div class="note" onclick="" style="cursor:pointer;">
				    				<div class="date">30-07-1212 <span class="time">10:12 uur</span></div>
				    				<div class="message">Begonnen met dagactiviteit. Toen ruzie	gekregen om een kleinigheid. Dit liep uit de hand. 
				    				Daarom de time-out begonnen. Dit werkte gelukkig goed!
									</div>
				    			</div>
				    			<div class="note">
				    				<div class="date">30-07-1212 <span class="time">10:12 uur</span></div>
				    				<div class="message">Begonnen met dagactiviteit. Toen ruzie	gekregen om een kleinigheid. Dit liep uit de hand. 
				    				Daarom de time-out begonnen. Dit werkte gelukkig goed!
									</div>
				    			</div>
				    			
				    		</div>
				    	</div>
				</div>
			</div>
			<div id="spaceFooter"></div>
		</div>
		</div>
	</body>
</html>
