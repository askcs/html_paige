<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=no; minimum-scale=1.0;">
    <link rel="stylesheet" type="text/css" href="style/main.css" />
    
	<!-- <script src="js/jquery-1.7.2.min.js"></script>
	<script src="js/jquery.ui.core-1.8.17.min.js"></script>
	<script src="js/jquery.ui.widget-1.8.17.min.js"></script> -->
	
	<script src="js/libs.min.js"></script>
	<script src="js/core.min.js"></script>
	<script src="js/phone.min.js"></script>
	
    <script type="text/javascript">
  	$(document).ready(function(){
		
  		$("#toggleMenu").click(function () {
		    $(this).toggleClass("notActive, active");
		    $("#headerMenu").toggleClass("displayNone");
	    }); 
  		
  		$("#timeoutButton").click(function () {
		    $(this).toggleClass("notPushed, pushed");
	    });    

	});
	
  	var d = document;
  	var safari = (navigator.userAgent.toLowerCase().indexOf('safari') != -1) ? true : false;
  	var gebtn = function(parEl,child) { return parEl.getElementsByTagName(child); };
  	onload = function() {
  	    
  	    var body = gebtn(d,'body')[0];
  	    body.className = body.className && body.className != '' ? body.className + ' has-js' : 'has-js';
  	    
  	    if (!d.getElementById || !d.createTextNode) return;
  	    var ls = gebtn(d,'label');
  	    for (var i = 0; i < ls.length; i++) {
  	        var l = ls[i];
  	        if (l.className.indexOf('label_') == -1) continue;
  	        var inp = gebtn(l,'input')[0];
  	        if (l.className == 'label_check') {
  	            l.className = (safari && inp.checked == true || inp.checked) ? 'label_check c_on' : 'label_check c_off';
  	            l.onclick = check_it;
  	        };
  	        if (l.className == 'label_radio') {
  	            l.className = (safari && inp.checked == true || inp.checked) ? 'label_radio r_on' : 'label_radio r_off';
  	            l.onclick = turn_radio;
  	        };
  	    };
  	};
  	var check_it = function() {
  	    var inp = gebtn(this,'input')[0];
  	    if (this.className == 'label_check c_off' || (!safari && inp.checked)) {
  	        this.className = 'label_check c_on';
  	        if (safari) inp.click();
  	    } else {
  	        this.className = 'label_check c_off';
  	        if (safari) inp.click();
  	    };
  	};
  	var turn_radio = function() {
  	    var inp = gebtn(this,'input')[0];
  	    if (this.className == 'label_radio r_off' || inp.checked) {
  	        var ls = gebtn(this.parentNode,'label');
  	        for (var i = 0; i < ls.length; i++) {
  	            var l = ls[i];
  	            if (l.className.indexOf('label_radio') == -1)  continue;
  	            l.className = 'label_radio r_off';
  	        };
  	        this.className = 'label_radio r_on';
  	        if (safari) inp.click();
  	    } else {
  	        this.className = 'label_radio r_off';
  	        if (safari) inp.click();
  	    };
  	};
  	
  	
  	
  	var login = function(){
  		
  	   	/*code for login from login_classic*/
        var usrName = $('#loginuuid').val().toLowerCase();
        var passStr = $('#loginpass').val();
        var passHash = MD5(passStr);
        
        if(usrName == "" || passStr == ""){
        	alert("Please fill the user name and password.")
        	return false;
        }
        
        var remember = $($('#contentContainer #rememberLogin')[0]).attr("checked");
        // console.log($($('#contentContainer #rememberLogin')[0]).is(':checked'));
        // console.log(remember)
        // return false;
        
        var login_animation = function(){
        	var dot = ".";
        	$('#loginButton').val($('#loginButton').val()+dot);
        	
        	if($('#loginButton').data("loginFlag")){
        		setTimeout(function(){
					login_animation();	        			
	        	},1000)
        	}else{
        		$('#loginButton').val("Inloggen");
        	}
        	
        }
        $('#loginButton').data("loginFlag",true);
        login_animation();
        
        console.log(session.appServices);
        $.Read({
            url: session.appServices + 'login',
            xhrFields: {
                withCredentials: true
            },
            data: {
                "uuid": '' + usrName,
                "pass": '' + passHash
            },
            200: function(data){
                console.log("received 200 ok on login.");
                var remember = $('#loginForm .rememberBox');
                // console.log(remember.attr("checked")); return false;
                session.addCallback('login', function() {
                    	if (phoneGapAvailable && window.plugins.sense) {
                            window.plugins.sense.changeLogin(usrName, passHash, function(){
                            	window.plugins.sense.toggleMain(true);
			                        			
                    			// set sense profile
                    			var profile = "timeout";
                    			if (profile && (sp = senseProfiles[profile])) {
                    				$.each(sp, function(k, v) {
                    					window.plugins.sense.setPref(k, v, function() {
                    					}, function() {
                    						console.log("Failed to set sense setting: " + k + ' = ' + v);
                    					});
                    				});
                    			}
                    			
                    			// start sense modules
                    			// TODO we don't need to start modules if none of their
                    			// corresponding prefs are enabled I guess?
                    			window.plugins.sense.togglePhoneState(false);
                    			window.plugins.sense.togglePosition(true);
                    			window.plugins.sense.toggleMotion(false);
                    			window.plugins.sense.toggleAmbience(true);
                    			window.plugins.sense.toggleNeighDev(false);
                    			
                            	$('#loginButton').val("Inloggen");
                            	$('#loginButton').data("loginFlag",false);
								window.location = "home.html";
                            }, function(){
                                alert("Paige can't access your sensors, some functions might not be working");
                                $('#loginButton').val("Inloggen");
                            });
                            
                        }else{
                        	console.log("Phone gap and sense plugin is not available");
                        	session.onLogin = null;
                        	
                        	handle_session(JSON.parse(data.responseText)["X-SESSION_ID"]);
                        	window.location = "home.html";
                        }
                });
                
                window.handle_session(JSON.parse(data.responseText)["X-SESSION_ID"]);
                localStorage.setItem("PaigeUser",usrName);
            },
            400: function(data){
                localStorage['password'] = '';//                              
                alert("Login failed: Please check your email or password");
                $('#loginButton').data("loginFlag",false);
            },
            error: function() {
            	alert("Login failed: Connection error.");
            	$('#loginButton').data("loginFlag",false);
            }
        });
        return false;	
  	}
  	
  	
  	$('#contentContainer #rememberLogin').ready(function(){
  		// read login from cookie 
  		var userName = getCookie("userName");
  		var userPass = getCookie("userPass");
  		if(userName != null && userName != ""){
  			$($('#contentContainer #rememberLogin')[0]).attr("checked","true");
  		}
  		// $("#loginuuid").val("");
  		// $("#loginpass").val("");
  	})
	</script>
    
    
    <title>Time out!</title>
  </head>

  <body>
  	<div id="contentContainer" class="loginPage">
        <div id="logo">
        	<div id="logoImage"></div>
        	<p>Time out!</p>
        </div>

        <form id='loginForm' name="LoginForm" method='POST' autocomplete='on' data-ajax="false" onsubmit="return login();">
            <input type='text' class="uname" name='uuid' id='loginuuid' placeholder='Emailadres' required/>
            <input type="password" class="pwd" name='pass' id='loginpass' placeholder='Wachtwoord' required/>
            <label class="label_check" for="rememberLogin">
			    <input name="sample-check" id="rememberLogin" value="1" type="checkbox" class="rememberBox" />
			    Onthoud mij
			</label>
            
            
            <input type="submit" id="loginButton" class="button" value='Inloggen'/>
            
            <div id="forgotpassRegister">
            <a href="forgotpass.html" class="forgotPass">Wachtwoord vergeten?</a>
            |
            <a href="register.html" class="register">Registreren</a>
            </div>
        </form>
</div>
            

        </div>
    </div>
</body>
</html>
